# 要件定義書

## 1. システム概要

### 1.1 システム名
東京23区マンション価格予測システム

### 1.2 目的
東京23区の不動産取引データ（CSVファイル）を機械学習モデルで分析し、マンション価格を予測するWebアプリケーション。
教育目的で構築された機械学習アプリケーションとして、データの可視化と予測結果の提示を行う。

### 1.3 対象ユーザー
- 不動産価格の分析を学習したい学生
- 機械学習の実践例を理解したい開発者
- 東京23区のマンション価格動向を把握したい一般ユーザー

---

## 2. 機能要件

### 2.1 CSVファイルアップロード機能
**機能ID:** F-001
**優先度:** 高

#### 概要
ユーザーが東京23区の不動産取引データ（CSV形式）をアップロードし、システムに取り込む機能。

#### 入力
- CSVファイル（エンコーディング: CP932）
- 必須カラム:
  - 取引価格（総額）
  - 面積（㎡）
  - 最寄駅：距離（分）
  - 建築年
  - 市区町村名
  - 取引時期

#### 処理
1. ファイルを`input/`ディレクトリに保存
2. CSVファイルのバリデーション
3. データの前処理・クレンジング
4. 機械学習モデルによる予測実行

#### 出力
- 予測結果概要ページへの遷移

#### 制約条件
- ファイル形式: CSV
- エンコーディング: CP932（日本語Windows標準）
- BOM付きCSVにも対応

---

### 2.2 機械学習による価格予測機能
**機能ID:** F-002
**優先度:** 高

#### 概要
Random Forestアルゴリズムを用いて、マンション価格を予測する。

#### アルゴリズム
- **モデル:** Random Forest Regressor
- **学習データ:** アップロードされたCSVデータの80%
- **テストデータ:** 20%
- **特徴量:**
  - 面積（㎡）
  - 最寄駅距離（分）
  - 建築年
  - 取引年
  - 市区町村名（ダミー変数化）
  - 築年帯（ダミー変数化）

#### データ前処理
1. **欠損値処理:** 欠損値を含む行を削除
2. **データクレンジング:**
   - 建築年: "年"を削除して数値化
   - 最寄駅距離: "分"、"H"（時間）、"～"（範囲）の処理
   - 取引時期から取引年を抽出
3. **特徴量エンジニアリング:**
   - 築年帯の分類（築10年未満、築10～20年、築20年以上）
4. **カテゴリ変数のエンコーディング:**
   - One-Hot Encoding（市区町村名、築年帯）

#### 評価指標
- **RMSE（Root Mean Squared Error）:** 予測誤差の平均
- **R²スコア（決定係数）:** モデルの説明力（0～1、1に近いほど高精度）

---

### 2.3 予測結果概要表示機能
**機能ID:** F-003
**優先度:** 高

#### 概要
予測モデルの精度指標と各分析ページへのリンクを表示。

#### 表示項目
- RMSE（平均二乗誤差の平方根）
- R²スコア（決定係数）
- ナビゲーションリンク:
  - 区ごとの予測ページ
  - 築年帯ごとの予測ページ
  - グラフ表示ページ
  - トップページ

---

### 2.4 区ごとの予測価格表示機能
**機能ID:** F-004
**優先度:** 高

#### 概要
東京23区ごとに、予測価格と実際の平均価格を比較表示する。

#### 表示項目
- 市区町村名
- 予測平均価格（万円）
- 実際の平均価格（万円）

#### データ処理
- 全データを用いて再学習したモデルで予測
- 区ごとにグループ化して平均値を算出

---

### 2.5 築年帯ごとの予測価格表示機能
**機能ID:** F-005
**優先度:** 中

#### 概要
区×築年帯のマトリクスで予測価格を表示する。

#### 表示項目
- 市区町村名
- 築年帯別予測価格（万円）
  - 築10年未満
  - 築10～20年
  - 築20年以上

#### データ処理
- 築年帯を以下のように分類:
  - 築10年未満: 2025 - 建築年 ≤ 10
  - 築10～20年: 10 < 2025 - 建築年 ≤ 20
  - 築20年以上: 2025 - 建築年 > 20

---

### 2.6 グラフ可視化機能
**機能ID:** F-006
**優先度:** 高

#### 概要
予測結果を視覚的に理解するためのグラフを生成・表示する。

#### グラフ種別

##### (1) 実際価格 vs 予測価格の散布図
- **軸:**
  - X軸: 実際の価格（百万円）
  - Y軸: 予測価格（百万円）
- **表示範囲:** 0～2億円
- **要素:**
  - 散布点（オレンジ色、透明度0.7）
  - 理想線（赤色破線、y=x）
  - グリッド線

##### (2) 年次別平均価格推移グラフ
- **軸:**
  - X軸: 取引年
  - Y軸: 平均価格（円）
- **グラフ形式:** 折れ線グラフ（マーカー付き）

#### 技術仕様
- **ライブラリ:** Matplotlib
- **保存形式:** PNG（DPI: 300）
- **保存先:** `static/`ディレクトリ
- **日本語フォント対応:** クロスプラットフォーム対応
  - macOS: ヒラギノ角ゴシック
  - Windows: Yu Gothic / MS Gothic
  - Linux: Noto Sans CJK JP

---

## 3. 非機能要件

### 3.1 性能要件
- **レスポンスタイム:**
  - CSVアップロード～予測完了: 30秒以内（データ件数1万件以下の場合）
  - ページ遷移: 3秒以内
- **同時接続数:** 10ユーザー以下（教育用途想定）

### 3.2 可用性
- **稼働率:** 特に要求なし（開発環境での利用想定）
- **バックアップ:** 不要

### 3.3 セキュリティ
- **認証:** なし
- **アップロードファイル検証:** ファイル形式のみ（CSV）
- **注意事項:** 本番環境では使用しない（debug=True設定）

### 3.4 保守性
- **コード可読性:**
  - 関数ごとに明確な責務分離
  - コメントによる日本語説明
- **ログ出力:** 標準出力への簡易ログ（フォント設定等）

### 3.5 移植性
- **対応OS:** macOS、Windows、Linux
- **Python バージョン:** 3.9以上
- **依存ライブラリ:**
  - Flask
  - pandas
  - numpy
  - scikit-learn
  - matplotlib

### 3.6 ユーザビリティ
- **UI/UX:**
  - シンプルでわかりやすいページ構成
  - 日本語による表示
  - レスポンシブデザインは不要（デスクトップ想定）
- **エラーメッセージ:** 現状エラーハンドリング未実装

---

## 4. 外部インターフェース

### 4.1 入力インターフェース
- **CSV形式:** 国土交通省「不動産取引価格情報」形式
- **エンコーディング:** CP932

### 4.2 出力インターフェース
- **Webブラウザ:** HTML5対応ブラウザ
- **画像ファイル:** PNG形式（静的ファイルとして配信）

---

## 5. システム制約

### 5.1 技術制約
- Flaskフレームワークを使用
- 機械学習モデルはメモリ上で保持（永続化なし）
- グローバル変数による状態管理（スケーラビリティなし）

### 5.2 運用制約
- 開発モード（debug=True）での実行
- ポート5002での起動
- 単一ユーザー利用想定（セッション管理なし）

### 5.3 データ制約
- アップロードファイルサイズ制限なし（Flaskデフォルト設定）
- 過去のアップロードデータは保持しない（都度上書き）

---

## 6. 用語集

| 用語 | 説明 |
|------|------|
| RMSE | Root Mean Squared Error（平均二乗誤差の平方根）。予測誤差の大きさを表す指標 |
| R²スコア | 決定係数。モデルの説明力を示す（0～1の値、1に近いほど高精度） |
| Random Forest | 複数の決定木を組み合わせた機械学習アルゴリズム |
| 築年帯 | マンションの築年数を分類したカテゴリ |
| One-Hot Encoding | カテゴリ変数を0/1のバイナリ変数に変換する手法 |
| CP932 | 日本語Windows標準の文字エンコーディング（Shift_JISの拡張） |

---

## 7. 今後の拡張性

### 7.1 想定される機能追加
- 個別条件入力による価格予測機能（コメントアウト済み）
- データベースによるデータ永続化
- ユーザー認証機能
- 複数モデルの比較機能
- 予測精度向上のためのハイパーパラメータ調整

### 7.2 改善課題
- エラーハンドリングの実装
- セッション管理の導入
- グローバル変数の排除
- モデルの永続化（pickle等）
- ユニットテストの追加
