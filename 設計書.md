# 設計書

## 1. システム設計概要

### 1.1 システム構成
本システムは、FlaskベースのWebアプリケーションとして構成され、以下の3層アーキテクチャを採用しています。

```
┌─────────────────────────────────────┐
│      プレゼンテーション層             │
│  (Flask Templates + HTML/CSS)       │
└─────────────────────────────────────┘
              ↓↑
┌─────────────────────────────────────┐
│        アプリケーション層             │
│         (Flask Routes)              │
└─────────────────────────────────────┘
              ↓↑
┌─────────────────────────────────────┐
│         ビジネスロジック層            │
│   (model_utils.py + scikit-learn)   │
└─────────────────────────────────────┘
```

---

## 2. アーキテクチャ設計

### 2.1 システムアーキテクチャ

```
[ユーザー(ブラウザ)]
        ↓
[Flask Web Server] (app.py)
        ↓
   ┌────┴────┐
   ↓         ↓
[Routes]  [model_utils.py]
   ↓         ↓
[Templates] [機械学習処理]
   ↓         ↓
 [HTML]   [CSV処理 + 予測]
            ↓
        [静的画像生成]
```

### 2.2 ディレクトリ構造

```
newme/
├── app.py                    # Flaskアプリケーションのエントリーポイント
├── model_utils.py            # 機械学習処理モジュール
├── README                    # 環境設定ファイル
├── 要件定義書.md              # 要件定義書
├── 設計書.md                  # 本ドキュメント
│
├── templates/                # HTMLテンプレート
│   ├── base.html             # ベーステンプレート
│   ├── upload.html           # ファイルアップロードページ
│   ├── result_overview.html  # 予測結果概要ページ
│   ├── result_by_ward.html   # 区ごとの予測ページ
│   ├── result_by_era.html    # 築年帯ごとの予測ページ
│   └── result_graphs.html    # グラフ表示ページ
│
├── static/                   # 静的ファイル
│   ├── result.png            # 散布図
│   └── yearly_trend.png      # 年次推移グラフ
│
├── input/                    # アップロードされたCSVファイル格納
│   └── *.csv
│
└── .venv/                    # Python仮想環境
```

---

## 3. モジュール設計

### 3.1 app.py（Flaskアプリケーション）

#### 3.1.1 概要
Webアプリケーションのルーティングとビュー制御を担当。

#### 3.1.2 グローバル変数

| 変数名 | 型 | 説明 |
|--------|-----|------|
| `rmse` | float | モデルの予測誤差（RMSE） |
| `r2` | float | モデルの決定係数（R²スコア） |
| `plot_path` | str | 散布図のファイルパス |
| `predictions_by_ward` | dict | 区ごとの予測価格 |
| `actual_prices_by_ward` | dict | 区ごとの実際の平均価格 |
| `era_predictions` | dict | 区×築年帯の予測価格マトリクス |

#### 3.1.3 ルート設計

##### (1) `/` (GET/POST)
- **機能:** CSVファイルアップロード
- **メソッド:** GET, POST
- **テンプレート:** `upload.html`
- **処理フロー:**
  1. GETリクエスト: アップロードフォームを表示
  2. POSTリクエスト:
     - ファイルを`input/`ディレクトリに保存
     - `process_and_predict()`を呼び出し
     - 予測結果をグローバル変数に格納
     - `/result_overview`にリダイレクト

##### (2) `/result_overview` (GET)
- **機能:** 予測結果概要の表示
- **メソッド:** GET
- **テンプレート:** `result_overview.html`
- **レンダリング変数:**
  - `rmse`: RMSE値
  - `r2`: R²スコア

##### (3) `/result_by_ward` (GET)
- **機能:** 区ごとの予測価格表示
- **メソッド:** GET
- **テンプレート:** `result_by_ward.html`
- **レンダリング変数:**
  - `predictions`: 区ごとの予測価格辞書
  - `actuals`: 区ごとの実際の平均価格辞書

##### (4) `/result_by_era` (GET)
- **機能:** 築年帯ごとの予測価格表示
- **メソッド:** GET
- **テンプレート:** `result_by_era.html`
- **レンダリング変数:**
  - `eras`: 区×築年帯の予測価格辞書

##### (5) `/result_graphs` (GET)
- **機能:** グラフ表示
- **メソッド:** GET
- **テンプレート:** `result_graphs.html`
- **レンダリング変数:**
  - `image_path`: 散布図のパス

---

### 3.2 model_utils.py（機械学習処理モジュール）

#### 3.2.1 関数一覧

##### (1) `setup_japanese_font()`
```python
def setup_japanese_font() -> None
```

**目的:** クロスプラットフォーム対応の日本語フォント設定

**処理内容:**
1. 実行環境のOS判定（`platform.system()`）
2. OS別フォント設定:
   - macOS: ヒラギノ角ゴシック系
   - Windows: Yu Gothic / MS Gothic
   - Linux: Noto Sans CJK JP
3. matplotlibのフォント設定を更新
4. マイナス記号の文字化け対策

**戻り値:** なし

---

##### (2) `parse_distance(distance)`
```python
def parse_distance(distance: Union[str, int, float]) -> Union[int, float]
```

**目的:** 最寄駅距離データの正規化

**処理内容:**
- 文字列形式の距離を数値（分）に変換
- パターン:
  - `"5分"` → 5
  - `"1H30分"` → 90（1時間30分）
  - `"5～10分"` → 7.5（平均値）

**引数:**
- `distance` (str | int | float): 距離データ

**戻り値:**
- (int | float): 正規化された距離（分）

---

##### (3) `process_and_predict(file_path, plot_path)`
```python
def process_and_predict(
    file_path: str,
    plot_path: str = "static/result.png"
) -> Tuple[float, float, str, dict, dict, dict]
```

**目的:** CSV読み込み～予測～可視化の一連処理

**処理フロー:**

```
┌─────────────────────────┐
│ 1. CSV読み込み           │
│   - エンコーディング: CP932 │
│   - BOM削除              │
└──────────┬──────────────┘
           ↓
┌─────────────────────────┐
│ 2. データ前処理           │
│   - 必要カラム抽出        │
│   - データ型変換          │
│   - 距離データ正規化      │
│   - 取引年抽出           │
│   - 築年帯分類           │
└──────────┬──────────────┘
           ↓
┌─────────────────────────┐
│ 3. 特徴量エンジニアリング  │
│   - 欠損値削除           │
│   - ダミー変数化         │
│   - 不要カラム削除       │
└──────────┬──────────────┘
           ↓
┌─────────────────────────┐
│ 4. モデル学習            │
│   - Train/Test分割(8:2) │
│   - Random Forest学習    │
│   - テストデータ予測     │
│   - 評価指標計算         │
└──────────┬──────────────┘
           ↓
┌─────────────────────────┐
│ 5. 散布図生成            │
│   - 2億円以下でフィルタ  │
│   - 実測vs予測プロット   │
└──────────┬──────────────┘
           ↓
┌─────────────────────────┐
│ 6. 全データ再学習        │
│   - 全データで再予測     │
│   - 区ごと集計           │
│   - 築年帯別集計         │
└──────────┬──────────────┘
           ↓
┌─────────────────────────┐
│ 7. 年次推移グラフ生成    │
└──────────┬──────────────┘
           ↓
        [戻り値]
```

**引数:**
- `file_path` (str): CSVファイルパス
- `plot_path` (str): 散布図保存先パス（デフォルト: "static/result.png"）

**戻り値:**
- `rmse` (float): RMSE値
- `r2` (float): R²スコア
- `plot_path` (str): 散布図パス
- `ward_predictions` (dict): 区ごとの予測価格
- `ward_actuals` (dict): 区ごとの実際価格
- `by_ward_and_era` (dict): 区×築年帯の予測価格

---

## 4. データモデル設計

### 4.1 入力データ構造（CSV）

| カラム名 | データ型 | 説明 | 例 |
|----------|---------|------|-----|
| 取引価格（総額） | int | 取引価格（円） | 54000000 |
| 面積（㎡） | float | 専有面積 | 45.0 |
| 最寄駅：距離（分） | str | 駅までの徒歩時間 | "5分" |
| 建築年 | str | 建築年 | "2005年" |
| 市区町村名 | str | 所在地（区） | "千代田区" |
| 取引時期 | str | 取引時期 | "2024年第2四半期" |

### 4.2 特徴量データ構造（学習用）

前処理後のデータフレーム構造:

| カラム名 | データ型 | 説明 |
|----------|---------|------|
| 面積（㎡） | float | 専有面積 |
| 最寄駅：距離（分） | float | 駅までの徒歩時間（正規化済み） |
| 建築年 | int | 建築年（数値） |
| 取引年 | int | 取引年 |
| 市区町村名_中央区 | int | ダミー変数（0 or 1） |
| 市区町村名_港区 | int | ダミー変数（0 or 1） |
| ... | int | 各区のダミー変数 |
| 築年帯_築10～20年 | int | ダミー変数（0 or 1） |
| 築年帯_築20年以上 | int | ダミー変数（0 or 1） |

### 4.3 出力データ構造

#### (1) ward_predictions（区ごとの予測価格）
```python
{
    "千代田区": 85000000,
    "中央区": 78000000,
    "港区": 92000000,
    ...
}
```

#### (2) ward_actuals（区ごとの実際価格）
```python
{
    "千代田区": 83000000,
    "中央区": 76000000,
    "港区": 90000000,
    ...
}
```

#### (3) by_ward_and_era（区×築年帯の予測価格）
```python
{
    "千代田区": {
        "築10年未満": 95000000,
        "築10～20年": 85000000,
        "築20年以上": 75000000
    },
    "中央区": {
        "築10年未満": 88000000,
        ...
    },
    ...
}
```

---

## 5. UI設計

### 5.1 画面遷移図

```
┌──────────────┐
│  トップページ  │ (/)
│ (upload.html) │
└───────┬──────┘
        │ CSVアップロード
        ↓
┌──────────────┐
│ 予測結果概要  │ (/result_overview)
│(result_overview.html)
└───┬───┬───┬──┘
    │   │   │
    ├───┼───┼────────────┐
    │   │   │            │
    ↓   ↓   ↓            ↓
  ┌─┐ ┌─┐ ┌─┐      ┌─────┐
  │区│ │築│ │グ│      │トップ│
  │別│ │年│ │ラ│      │ へ戻る
  │予│ │帯│ │フ│      └─────┘
  │測│ │別│ │表│
  └─┘ └─┘ └─┘
```

### 5.2 画面設計詳細

#### 5.2.1 トップページ (upload.html)

**レイアウト:**
```
┌────────────────────────────────┐
│ [ヘッダー]                      │
│  東京23区マンション価格予想      │
├────────────────────────────────┤
│                                 │
│  [フォーム]                     │
│  CSVファイルをアップロードしてください │
│  [ファイル選択]                  │
│  [アップロードして予測] ボタン     │
│                                 │
└────────────────────────────────┘
```

**CSS特徴:**
- 背景色: #eef2f7
- ヘッダー: ダークブルー (#2c3e50)
- ボタン: ブルー (#3498db)

---

#### 5.2.2 予測結果概要ページ (result_overview.html)

**レイアウト:**
```
┌────────────────────────────────┐
│ [予測の概要]                    │
│                                 │
│ RMSE: 12345678.90               │
│ R²スコア: 0.85                  │
│                                 │
│ ▶ 区ごとの予測へ                │
│ ▶ 築年帯ごとの予測へ            │
│ ▶ グラフを見る                  │
│ トップに戻る                    │
└────────────────────────────────┘
```

**ベーステンプレート:** `base.html`を継承

---

#### 5.2.3 区ごとの予測ページ (result_by_ward.html)

**レイアウト:**
```
┌────────────────────────────────┐
│ [区ごとの予測価格と実際価格(万円)] │
│                                 │
│ ・千代田区: 予測 8,500万円       │
│            実際 8,300万円       │
│ ・中央区: 予測 7,800万円         │
│          実際 7,600万円         │
│ ...                             │
│                                 │
│ ⬅ 概要へ戻る                    │
└────────────────────────────────┘
```

---

#### 5.2.4 築年帯ごとの予測ページ (result_by_era.html)

**レイアウト:**
```
┌────────────────────────────────┐
│ [築年帯ごとの予測価格(万円)]     │
│                                 │
│ [千代田区]                      │
│  ・築10年未満: 9,500万円         │
│  ・築10～20年: 8,500万円         │
│  ・築20年以上: 7,500万円         │
│                                 │
│ [中央区]                        │
│  ...                            │
│                                 │
│ ⬅ 概要へ戻る                    │
└────────────────────────────────┘
```

---

#### 5.2.5 グラフ表示ページ (result_graphs.html)

**レイアウト:**
```
┌────────────────────────────────┐
│ [グラフで見る予測結果]           │
│                                 │
│ [年次別の平均価格推移]           │
│  [グラフ画像表示]                │
│                                 │
│ [実測と予測の散布図]             │
│  [グラフ画像表示]                │
│                                 │
│ ⬅ 概要へ戻る                    │
└────────────────────────────────┘
```

---

## 6. データベース設計

本システムではデータベースは使用せず、以下の方法でデータを管理:

- **セッション管理:** なし（グローバル変数で状態保持）
- **データ永続化:** なし（アプリ再起動で消失）
- **ファイルストレージ:**
  - CSV: `input/` ディレクトリ
  - 画像: `static/` ディレクトリ

### 将来的なDB設計案

拡張する場合のテーブル設計例:

#### transactions テーブル
| カラム名 | データ型 | 制約 | 説明 |
|----------|---------|------|------|
| id | INTEGER | PK | 取引ID |
| price | INTEGER | NOT NULL | 取引価格 |
| area | FLOAT | NOT NULL | 面積 |
| station_distance | FLOAT | NOT NULL | 駅距離 |
| build_year | INTEGER | NOT NULL | 建築年 |
| ward | VARCHAR(50) | NOT NULL | 区名 |
| transaction_year | INTEGER | NOT NULL | 取引年 |
| created_at | TIMESTAMP | DEFAULT NOW() | 登録日時 |

#### predictions テーブル
| カラム名 | データ型 | 制約 | 説明 |
|----------|---------|------|------|
| id | INTEGER | PK | 予測ID |
| transaction_id | INTEGER | FK | 取引ID |
| predicted_price | INTEGER | NOT NULL | 予測価格 |
| rmse | FLOAT | | RMSE |
| r2_score | FLOAT | | R²スコア |
| created_at | TIMESTAMP | DEFAULT NOW() | 予測日時 |

---

## 7. エラーハンドリング設計

### 7.1 現状のエラーハンドリング

現在、明示的なエラーハンドリングは実装されていません。

### 7.2 想定されるエラーケース

| エラー種別 | 原因 | 現状の動作 | 推奨対応 |
|-----------|------|-----------|---------|
| ファイル未選択 | ファイルなしで送信 | 500エラー | フォームバリデーション追加 |
| CSV形式不正 | 必須カラム不足 | 例外発生 | try-exceptでキャッチ、エラーページ表示 |
| データ型不正 | 数値変換失敗 | NaNになり削除 | ログ出力、警告表示 |
| メモリ不足 | 大量データ処理 | プロセスクラッシュ | チャンク処理、データサイズ制限 |
| フォント読み込み失敗 | フォントファイル不在 | デフォルトフォント使用 | 現状OK（フォールバック実装済み） |

### 7.3 推奨エラーハンドリング実装例

```python
@app.route("/", methods=["GET", "POST"])
def upload_file():
    if request.method == "POST":
        file = request.files.get("file")
        if not file or file.filename == "":
            flash("ファイルが選択されていません")
            return redirect(url_for("upload_file"))

        try:
            filepath = os.path.join("input", file.filename)
            file.save(filepath)

            rmse, r2, ... = process_and_predict(filepath)
            return redirect(url_for("result_overview"))

        except KeyError as e:
            flash(f"CSVに必要なカラムが不足しています: {e}")
            return redirect(url_for("upload_file"))
        except Exception as e:
            flash(f"予測処理中にエラーが発生しました: {e}")
            return redirect(url_for("upload_file"))
```

---

## 8. セキュリティ設計

### 8.1 現状のセキュリティレベル

- **認証:** なし
- **CSRF対策:** なし（Flask-WTForms未使用）
- **ファイルアップロード検証:** 拡張子チェックなし
- **SQL Injection:** 該当なし（DB未使用）
- **XSS対策:** Jinja2のエスケープに依存

### 8.2 セキュリティリスク

| リスク | 深刻度 | 対策 |
|--------|--------|------|
| 任意ファイルアップロード | 高 | 拡張子・MIMEタイプ検証 |
| DoS攻撃（大容量ファイル） | 中 | ファイルサイズ制限 |
| パス・トラバーサル | 中 | ファイル名サニタイズ |
| デバッグモード有効 | 高 | 本番環境では無効化 |

### 8.3 推奨セキュリティ対策

```python
import os
from werkzeug.utils import secure_filename

ALLOWED_EXTENSIONS = {'csv'}
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route("/", methods=["POST"])
def upload_file():
    if 'file' not in request.files:
        return "ファイルがありません", 400

    file = request.files['file']
    if not allowed_file(file.filename):
        return "CSVファイルのみアップロード可能です", 400

    filename = secure_filename(file.filename)
    filepath = os.path.join("input", filename)
    file.save(filepath)
```

---

## 9. パフォーマンス設計

### 9.1 処理時間の最適化

| 処理 | 現状の時間（推定） | 最適化手法 |
|------|------------------|----------|
| CSV読み込み | 1～3秒 | チャンク読み込み（`chunksize`） |
| データ前処理 | 2～5秒 | ベクトル化演算（pandas最適化） |
| モデル学習 | 5～10秒 | `n_jobs=-1`（並列処理） |
| グラフ生成 | 2～4秒 | 解像度調整、非同期生成 |

### 9.2 メモリ使用量の最適化

**現状の課題:**
- 全データをメモリに保持
- グローバル変数による重複保持

**改善策:**
```python
# Random Forestの並列処理有効化
model = RandomForestRegressor(
    random_state=42,
    n_jobs=-1,  # 全CPUコア使用
    max_depth=20,  # 深さ制限でメモリ削減
)

# 不要データの早期削除
del df_original
import gc
gc.collect()
```

---

## 10. テスト設計

### 10.1 単体テスト（Unit Test）

#### model_utils.py のテスト

```python
import unittest
from model_utils import parse_distance, setup_japanese_font

class TestModelUtils(unittest.TestCase):

    def test_parse_distance_minutes(self):
        self.assertEqual(parse_distance("5分"), 5)

    def test_parse_distance_hours(self):
        self.assertEqual(parse_distance("1H30分"), 90)

    def test_parse_distance_range(self):
        self.assertEqual(parse_distance("5～10分"), 7.5)

    def test_parse_distance_numeric(self):
        self.assertEqual(parse_distance(10), 10)
```

### 10.2 統合テスト（Integration Test）

```python
class TestFlaskApp(unittest.TestCase):

    def setUp(self):
        app.config['TESTING'] = True
        self.client = app.test_client()

    def test_upload_page_loads(self):
        response = self.client.get('/')
        self.assertEqual(response.status_code, 200)

    def test_file_upload(self):
        data = {'file': (open('test.csv', 'rb'), 'test.csv')}
        response = self.client.post('/', data=data)
        self.assertEqual(response.status_code, 302)  # リダイレクト
```

### 10.3 テストデータ

**test.csv の構造:**
```csv
取引価格（総額）,面積（㎡）,最寄駅：距離（分）,建築年,市区町村名,取引時期
50000000,40,5分,2010年,千代田区,2024年第1四半期
80000000,60,10分,2015年,港区,2024年第1四半期
```

---

## 11. デプロイ設計

### 11.1 開発環境

**実行コマンド:**
```bash
source .venv/bin/activate
python app.py
```

**アクセスURL:**
```
http://localhost:5002
```

### 11.2 本番環境（推奨構成）

#### サーバー構成
```
[Nginx] → [Gunicorn] → [Flask App]
           ↓
        [Redis] (セッション管理)
           ↓
     [PostgreSQL] (データ永続化)
```

#### デプロイコマンド例
```bash
# Gunicornで起動
gunicorn -w 4 -b 0.0.0.0:8000 app:app

# Systemdサービス化
sudo systemctl start flask-app
```

#### 環境変数設定
```bash
export FLASK_ENV=production
export SECRET_KEY=<ランダム文字列>
export DATABASE_URL=postgresql://user:pass@localhost/dbname
```

### 11.3 Docker化（推奨）

**Dockerfile:**
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "app:app"]
```

**docker-compose.yml:**
```yaml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./input:/app/input
      - ./static:/app/static
    environment:
      - FLASK_ENV=production
```

---

## 12. 保守運用設計

### 12.1 ログ設計

**推奨ログ実装:**
```python
import logging

logging.basicConfig(
    filename='app.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

@app.route("/", methods=["POST"])
def upload_file():
    logging.info(f"File uploaded: {file.filename}")
    try:
        # 処理
        logging.info("Prediction completed successfully")
    except Exception as e:
        logging.error(f"Prediction failed: {e}")
```

### 12.2 モニタリング

**監視項目:**
- アプリケーションの応答時間
- エラー発生率
- ファイルアップロード数
- メモリ使用量
- CPU使用率

### 12.3 バックアップ戦略

**バックアップ対象:**
- `input/` ディレクトリ（アップロードファイル）
- `static/` ディレクトリ（生成画像）
- ログファイル

**バックアップスケジュール:**
- 日次: ローカルバックアップ
- 週次: 外部ストレージへ転送

---

## 13. 依存ライブラリ

### 13.1 requirements.txt

```
Flask==2.3.0
pandas==2.0.0
numpy==1.24.0
scikit-learn==1.2.2
matplotlib==3.7.1
```

### 13.2 Python バージョン

- **推奨:** Python 3.9 以上
- **検証済み:** Python 3.9

---

## 14. 制約事項と既知の問題

### 14.1 制約事項
- シングルユーザー利用を想定（セッション管理なし）
- グローバル変数使用によるスケーラビリティの制約
- デバッグモード有効（本番環境では使用不可）

### 14.2 既知の問題
- ファイルアップロード時のエラーハンドリング未実装
- CSRF対策未実装
- ファイルサイズ制限なし
- 同時アップロード時のデータ競合

### 14.3 今後の改善計画
1. セッション管理の実装
2. データベース導入
3. エラーハンドリングの強化
4. ユニットテストの追加
5. CI/CDパイプラインの構築

---

## 15. 参考資料

### 15.1 使用技術
- Flask公式ドキュメント: https://flask.palletsprojects.com/
- scikit-learn公式ドキュメント: https://scikit-learn.org/
- pandas公式ドキュメント: https://pandas.pydata.org/
- matplotlib公式ドキュメント: https://matplotlib.org/

### 15.2 データソース
- 国土交通省「不動産取引価格情報」

---

## 改訂履歴

| 版数 | 日付 | 変更内容 | 作成者 |
|------|------|---------|--------|
| 1.0 | 2025-10-25 | 初版作成 | - |
